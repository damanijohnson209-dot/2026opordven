<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Venezuela Absolute Resolve - Operational Weather</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@300;400;500;700&family=Bebas+Neue&display=swap" rel="stylesheet" />

<style>
/* Ops-console styling (cleaned: valid CSS variables, no smart quotes) */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root{
  --bg-void:#050709; --bg-base:#080c10; --bg-surface:#0c1219; --bg-raised:#101820; --bg-card:#121a24; --bg-hover:#172030;
  --border-dim:#1a2535; --border-mid:#243548; --border-bright:#2e4560; --border-glow:rgba(0,210,255,0.3);
  --accent:#00d2ff; --accent-dim:#0099bb; --accent-glow:rgba(0,210,255,0.12);
  --amber:#ffb800; --amber-dim:rgba(255,184,0,0.15);
  --red:#ff3355; --red-dim:rgba(255,51,85,0.15);
  --green:#00ff9d; --green-dim:rgba(0,255,157,0.12);
  --text-primary:#d0e4f0; --text-secondary:#7a9ab5; --text-dim:#3a5570; --text-muted:#253545;
  --header-h:58px; --loctab-h:46px; --navh:42px;
  --font-ui:"Exo 2",sans-serif; --font-mono:"JetBrains Mono",monospace; --font-display:"Bebas Neue",sans-serif;
  --radius:4px; --shadow-card:0 4px 24px rgba(0,0,0,0.6);
}

html,body{height:100%;background:var(--bg-void);color:var(--text-primary);font-family:var(--font-ui);overflow:hidden}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg-base)}
::-webkit-scrollbar-thumb{background:var(--border-bright);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--accent-dim)}

.hidden{display:none !important}
.fade-in{animation:fadeIn .22s ease both}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}

.status-dot{display:inline-block;width:7px;height:7px;border-radius:50%}
.status-dot.active{background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2.5s ease infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.35}}

.login-overlay{
  position:fixed;inset:0;background:var(--bg-void);
  display:flex;align-items:center;justify-content:center;z-index:9999;
  background-image:
    radial-gradient(ellipse 80% 60% at 50% 50%, rgba(0,210,255,0.04) 0%, transparent 70%),
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(0,210,255,0.03) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(0,210,255,0.03) 40px);
}
.login-box{
  background:var(--bg-surface);border:1px solid var(--border-mid);border-radius:8px;padding:40px 48px;
  width:420px;text-align:center;
  box-shadow:0 0 80px rgba(0,0,0,0.9),0 0 40px rgba(0,210,255,0.05);
  position:relative;
}
.login-box::before{
  content:"";position:absolute;top:0;left:30%;right:30%;
  height:1px;background:linear-gradient(90deg, transparent, var(--accent), transparent);
}
.login-emblem{width:72px;height:72px;margin:0 auto 24px;position:relative;display:flex;align-items:center;justify-content:center}
.emblem-ring{position:absolute;inset:0;border:1px solid var(--accent-dim);border-radius:50%;animation:spin 8s linear infinite;border-top-color:var(--accent);border-right-color:transparent}
@keyframes spin{to{transform:rotate(360deg)}}
.emblem-icon{font-size:32px;color:var(--accent);text-shadow:0 0 20px var(--accent)}
.login-title{font-family:var(--font-display);font-size:22px;letter-spacing:3px;color:var(--accent);margin-bottom:4px}
.login-subtitle{font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);letter-spacing:2px;margin-bottom:4px}
.login-classification{font-family:var(--font-mono);font-size:9px;color:var(--amber);letter-spacing:2px;margin-bottom:28px}
.login-fields{display:flex;flex-direction:column;gap:14px;text-align:left}
.field-group{display:flex;flex-direction:column;gap:5px}
.field-label{font-family:var(--font-mono);font-size:9px;color:var(--text-dim);letter-spacing:2px}
.login-input{
  background:var(--bg-raised);border:1px solid var(--border-mid);
  border-radius:var(--radius);color:var(--text-primary);
  font-family:var(--font-mono);font-size:13px;padding:10px 12px;outline:none;
  transition:border .2s, box-shadow .2s;
}
.login-input:focus{border-color:var(--accent-dim);box-shadow:0 0 0 2px var(--accent-glow)}
.login-hint{font-family:var(--font-mono);font-size:9px;color:var(--text-muted);text-align:center}
.login-btn{
  background:var(--accent-glow);border:1px solid var(--accent-dim);
  color:var(--accent);font-family:var(--font-display);font-size:16px;letter-spacing:3px;
  padding:12px;border-radius:var(--radius);cursor:pointer;display:flex;
  align-items:center;justify-content:center;gap:10px;margin-top:4px;width:100%;
  transition:all .2s;
}
.login-btn:hover{background:rgba(0,210,255,0.18);border-color:var(--accent);box-shadow:0 0 20px rgba(0,210,255,0.15)}
.login-error{font-family:var(--font-mono);font-size:10px;color:var(--red);text-align:center;padding:6px;border:1px solid var(--red-dim);border-radius:var(--radius);background:var(--red-dim);letter-spacing:1px}
.login-footer{margin-top:24px;font-family:var(--font-mono);font-size:10px;color:var(--text-dim);display:flex;align-items:center;justify-content:center;gap:6px}

.app{display:flex;flex-direction:column;height:100vh}
.header{
  height:var(--header-h);background:var(--bg-surface);
  border-bottom:1px solid var(--border-dim);
  display:flex;align-items:center;padding:0 16px;gap:16px;
  flex-shrink:0;position:relative;z-index:200;
}
.header::after{
  content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;
  background:linear-gradient(90deg, transparent 0%, var(--accent-dim) 30%, var(--accent-dim) 70%, transparent 100%);
  opacity:.4;
}
.header-left{display:flex;align-items:center;gap:12px;min-width:280px}
.header-logo{width:36px;height:36px;display:flex;align-items:center;justify-content:center}
.logo-hex{font-size:28px;color:var(--accent);text-shadow:0 0 15px var(--accent)}
.brand-mission{font-family:var(--font-display);font-size:17px;letter-spacing:2px;color:var(--accent);line-height:1}
.brand-sub{font-family:var(--font-mono);font-size:8px;color:var(--text-secondary);letter-spacing:1.5px;margin-top:3px}

.header-center{flex:1;display:flex;justify-content:center}
.search-wrap{position:relative;width:100%;max-width:440px}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:15px;pointer-events:none}
.search-input{
  width:100%;background:var(--bg-raised);border:1px solid var(--border-dim);
  border-radius:var(--radius);color:var(--text-primary);
  font-family:var(--font-mono);font-size:11px;padding:8px 32px 8px 34px;outline:none;
}
.search-input:focus{border-color:var(--border-bright)}
.search-input::placeholder{color:var(--text-muted)}
.search-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-dim);cursor:pointer;font-size:11px;display:none}
.search-clear.visible{display:block}

.header-right{display:flex;align-items:center;gap:16px;min-width:220px;justify-content:flex-end}
.header-clock{text-align:right}
.clock-utc{font-family:var(--font-mono);font-size:15px;color:var(--accent);letter-spacing:1px}
.clock-date{font-family:var(--font-mono);font-size:9px;color:var(--text-secondary);letter-spacing:1px}
.header-status{display:flex;align-items:center;gap:6px}
.status-label{font-family:var(--font-mono);font-size:9px;color:var(--text-secondary);letter-spacing:1px}
.logout-btn{background:none;border:1px solid var(--border-mid);border-radius:var(--radius);color:var(--text-dim);font-size:14px;width:30px;height:30px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.logout-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim)}

.loc-tabs{
  height:var(--loctab-h);background:var(--bg-base);
  border-bottom:1px solid var(--border-dim);
  display:flex;align-items:center;padding:0 16px;justify-content:space-between;flex-shrink:0
}
.loc-tab-track{display:flex;gap:4px;align-items:center}
.loc-tab{
  display:flex;flex-direction:column;align-items:flex-start;
  padding:6px 20px;border:1px solid transparent;border-bottom:none;border-radius:4px 4px 0 0;
  background:transparent;color:var(--text-secondary);cursor:pointer;transition:all .2s;gap:1px;position:relative;top:1px
}
.loc-tab:hover{background:var(--bg-raised);color:var(--text-primary)}
.loc-tab.active{background:var(--bg-surface);border-color:var(--border-mid);border-bottom-color:var(--bg-surface);color:var(--accent)}
.loc-tab.active::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent);border-radius:4px 4px 0 0}
.loc-icao{font-family:var(--font-display);font-size:18px;letter-spacing:2px;line-height:1}
.loc-name{font-family:var(--font-mono);font-size:8px;letter-spacing:1px;color:var(--text-dim)}
.loc-tab-add{background:none;border:1px dashed var(--border-mid);border-radius:var(--radius);color:var(--text-dim);font-family:var(--font-mono);font-size:10px;padding:4px 10px;cursor:pointer;margin-left:8px;transition:all .2s;letter-spacing:1px}
.loc-tab-add:hover{border-color:var(--accent-dim);color:var(--accent)}
.loc-cycle{display:flex;align-items:center;gap:8px}
.cycle-label{font-family:var(--font-mono);font-size:9px;color:var(--text-dim);letter-spacing:1px}
.cycle-select{background:var(--bg-raised);border:1px solid var(--border-mid);color:var(--accent);font-family:var(--font-mono);font-size:12px;padding:5px 10px;border-radius:var(--radius);outline:none;cursor:pointer}

.section-nav{
  height:var(--navh);background:var(--bg-surface);
  border-bottom:1px solid var(--border-dim);
  flex-shrink:0;overflow-x:auto;overflow-y:hidden
}
.section-nav::-webkit-scrollbar{height:2px}
.nav-items{display:flex;height:100%;padding:0 16px;gap:2px}
.nav-item{
  display:flex;align-items:center;gap:7px;padding:0 18px;background:transparent;border:none;border-bottom:2px solid transparent;
  color:var(--text-secondary);font-size:12px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:all .18s;white-space:nowrap
}
.nav-item .nav-icon{font-size:10px}
.nav-item:hover{color:var(--text-primary);border-bottom-color:var(--border-bright)}
.nav-item.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(0,210,255,0.04)}

.content{flex:1;overflow-y:auto;padding:20px;background:var(--bg-base)}
.page-header{margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid var(--border-dim)}
.page-header-inner{display:flex;align-items:flex-end;justify-content:space-between}
.page-title{font-family:var(--font-display);font-size:24px;letter-spacing:3px;color:var(--accent)}
.page-subtitle{font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);letter-spacing:1px;margin-top:4px}
.page-meta{display:flex;gap:10px;margin-top:8px;flex-wrap:wrap}
.meta-chip{font-family:var(--font-mono);font-size:9px;letter-spacing:1px;padding:3px 9px;border-radius:2px;border:1px solid var(--border-dim);color:var(--text-dim)}
.meta-chip.active{border-color:var(--accent-dim);color:var(--accent);background:var(--accent-glow)}

.collapsible{margin-bottom:14px;border:1px solid var(--border-dim);border-radius:6px;overflow:hidden}
.collapsible-header{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;background:var(--bg-card);cursor:pointer;transition:background .18s;user-select:none}
.collapsible-header:hover{background:var(--bg-hover)}
.collapsible-left{display:flex;align-items:center;gap:10px}
.collapsible-num{font-family:var(--font-mono);font-size:10px;color:var(--text-dim);min-width:30px}
.collapsible-title{font-size:13px;font-weight:600;letter-spacing:.5px;color:var(--text-primary)}
.collapsible-badge{font-family:var(--font-mono);font-size:9px;padding:2px 7px;border-radius:2px;border:1px solid var(--border-mid);color:var(--text-dim);letter-spacing:1px}
.collapsible-right{display:flex;align-items:center;gap:10px}
.chevron{font-size:10px;color:var(--text-dim);transition:transform .2s}
.chevron.open{transform:rotate(90deg)}
.collapsible-body{padding:16px;background:var(--bg-raised);border-top:1px solid var(--border-dim)}
.collapsed .collapsible-body{display:none}

.card{background:var(--bg-card);border:1px solid var(--border-dim);border-radius:6px;overflow:hidden;transition:border-color .2s;box-shadow:var(--shadow-card)}
.card:hover{border-color:var(--border-mid)}
.card-head{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;border-bottom:1px solid var(--border-dim);background:rgba(0,0,0,0.25)}
.card-title{font-size:11px;font-weight:700;letter-spacing:1.5px;color:var(--text-secondary);text-transform:uppercase}
.card-actions{display:flex;gap:5px}
.card-btn{background:none;border:1px solid var(--border-dim);border-radius:3px;color:var(--text-dim);font-family:var(--font-mono);font-size:10px;padding:3px 8px;cursor:pointer;transition:all .15s}
.card-btn:hover{border-color:var(--accent-dim);color:var(--accent)}
.card-btn.danger:hover{border-color:var(--red);color:var(--red)}
.card-body{padding:14px}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:900px){.grid-2{grid-template-columns:1fr}.header-left,.header-right{min-width:auto}}
@media(max-width:600px){.header{padding:0 10px;gap:8px}.brand-mission{font-size:14px}.content{padding:12px}}

.upload-zone{
  border:1px dashed var(--border-bright);border-radius:5px;min-height:150px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
  cursor:pointer;transition:all .2s;position:relative;background:rgba(0,0,0,0.2);overflow:hidden
}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--accent-dim);background:var(--accent-glow)}
.upload-zone.has-content{border-style:solid;border-color:var(--border-mid);min-height:auto}
.upload-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-icon{font-size:26px;color:var(--text-muted)}
.upload-text{font-family:var(--font-mono);font-size:10px;color:var(--text-dim);text-align:center;letter-spacing:1px;line-height:1.6}
.upload-text strong{color:var(--text-secondary)}
.upload-preview,.upload-gif{max-width:100%;max-height:380px;object-fit:contain;display:block;border-radius:3px}
.upload-controls{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}

.analysis-label{font-family:var(--font-mono);font-size:9px;letter-spacing:1.5px;color:var(--text-dim);margin-top:12px;margin-bottom:5px;display:block;text-transform:uppercase}
.analysis-field{
  width:100%;background:rgba(0,0,0,0.35);border:1px solid var(--border-dim);border-radius:3px;
  color:var(--text-primary);font-family:var(--font-mono);font-size:11px;padding:9px;resize:vertical;min-height:80px;outline:none;line-height:1.65
}
.analysis-field:focus{border-color:var(--accent-dim)}
.analysis-field::placeholder{color:var(--text-muted)}

.discussion-wrap{margin-top:10px}
.discussion-toggle{display:flex;align-items:center;gap:8px;font-family:var(--font-mono);font-size:10px;color:var(--text-dim);cursor:pointer;letter-spacing:1px;padding:4px 0}
.discussion-toggle:hover{color:var(--text-secondary)}
.discussion-field{
  width:100%;background:rgba(0,0,0,0.4);border:1px solid var(--border-dim);border-radius:3px;
  color:var(--text-secondary);font-family:var(--font-mono);font-size:11px;padding:8px;resize:vertical;min-height:60px;outline:none;line-height:1.6
}

.level-tabs{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap}
.level-tab{background:var(--bg-card);border:1px solid var(--border-dim);border-radius:3px;color:var(--text-secondary);font-family:var(--font-mono);font-size:11px;padding:5px 14px;cursor:pointer;letter-spacing:1px}
.level-tab:hover{border-color:var(--border-bright);color:var(--text-primary)}
.level-tab.active{background:var(--accent-glow);border-color:var(--accent-dim);color:var(--accent)}

.model-product-tabs{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
.model-product-tab{background:var(--bg-card);border:1px solid var(--border-dim);border-radius:3px;color:var(--text-secondary);font-family:var(--font-mono);font-size:10px;padding:4px 10px;cursor:pointer;letter-spacing:1px}
.model-product-tab.active{background:rgba(255,184,0,0.1);border-color:var(--amber-dim);color:var(--amber)}

.stoplight-table{width:100%;border-collapse:collapse;font-family:var(--font-mono);font-size:11px}
.stoplight-table th{padding:9px 12px;text-align:left;background:rgba(0,0,0,0.4);border:1px solid var(--border-dim);color:var(--text-secondary);font-size:10px;letter-spacing:1px;font-weight:500}
.stoplight-table td{padding:8px 12px;border:1px solid var(--border-dim);color:var(--text-primary);vertical-align:middle}
.stoplight-table select,.stoplight-table input{background:transparent;border:none;outline:none;color:inherit;font-family:var(--font-mono);font-size:11px;width:100%}
.g{color:var(--green)} .a{color:var(--amber)} .r{color:var(--red)}

.timeline{display:flex;gap:0;overflow-x:auto;padding-bottom:8px}
.timeline-day{min-width:140px;border:1px solid var(--border-dim);border-left:none}
.timeline-day:first-child{border-left:1px solid var(--border-dim);border-radius:4px 0 0 4px}
.timeline-day:last-child{border-radius:0 4px 4px 0}
.timeline-day-head{padding:7px 10px;background:rgba(0,0,0,0.3);border-bottom:1px solid var(--border-dim);text-align:center}
.timeline-day-label{font-family:var(--font-display);font-size:14px;letter-spacing:1px;color:var(--accent)}
.timeline-day-body{padding:10px}
.timeline-field{width:100%;background:transparent;border:none;outline:none;color:var(--text-primary);font-family:var(--font-mono);font-size:10px;resize:none;height:80px;line-height:1.5}
.timeline-risk{display:flex;gap:4px;justify-content:center;padding:6px 0;border-top:1px solid var(--border-dim)}
.timeline-risk-btn{width:20px;height:20px;border-radius:50%;border:2px solid;cursor:pointer;transition:transform .15s}
.timeline-risk-btn:hover{transform:scale(1.2)}
.timeline-risk-btn.grn{border-color:var(--green)} .timeline-risk-btn.amb{border-color:var(--amber)} .timeline-risk-btn.red{border-color:var(--red)}
.timeline-risk-btn.grn.on{background:var(--green);box-shadow:0 0 8px var(--green)}
.timeline-risk-btn.amb.on{background:var(--amber);box-shadow:0 0 8px var(--amber)}
.timeline-risk-btn.red.on{background:var(--red);box-shadow:0 0 8px var(--red)}

.archive-filters{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.archive-filters select,.archive-filters input{background:var(--bg-card);border:1px solid var(--border-dim);color:var(--text-primary);font-family:var(--font-mono);font-size:11px;padding:6px 10px;border-radius:3px;outline:none}
.archive-table{width:100%;border-collapse:collapse}
.archive-table th{padding:8px 12px;background:var(--bg-card);border:1px solid var(--border-dim);color:var(--text-secondary);font-family:var(--font-mono);font-size:10px;letter-spacing:1px;text-align:left}
.archive-table td{padding:9px 12px;border:1px solid var(--border-dim);font-family:var(--font-mono);font-size:11px;color:var(--text-primary)}
.archive-table tr:hover td{background:var(--bg-hover)}
.add-row-btn{margin-top:10px;background:var(--bg-card);border:1px dashed var(--border-mid);color:var(--text-secondary);font-family:var(--font-mono);font-size:10px;padding:7px 16px;border-radius:3px;cursor:pointer;letter-spacing:1px}

.asset-table{width:100%;border-collapse:collapse}
.asset-table th{padding:8px 12px;background:rgba(0,0,0,0.4);border:1px solid var(--border-dim);color:var(--text-secondary);font-family:var(--font-mono);font-size:10px;letter-spacing:1px}
.asset-table td{border:1px solid var(--border-dim);padding:0}
.asset-table td textarea{width:100%;background:transparent;border:none;outline:none;color:var(--text-primary);font-family:var(--font-mono);font-size:11px;padding:8px 10px;resize:none;min-height:60px;line-height:1.5}

.lightbox{position:fixed;inset:0;z-index:5000;display:flex;align-items:center;justify-content:center}
.lightbox-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.95)}
.lightbox-inner{position:relative;max-width:95vw;max-height:95vh}
.lightbox-close{position:absolute;top:-38px;right:0;background:none;border:1px solid var(--border-mid);border-radius:3px;color:var(--text-primary);font-family:var(--font-mono);font-size:11px;padding:4px 10px;cursor:pointer}
.lightbox-close:hover{border-color:var(--red);color:var(--red)}
.lightbox-inner img{max-width:95vw;max-height:88vh;object-fit:contain;border-radius:3px;position:relative;z-index:1}
.lightbox-caption{position:relative;z-index:1;font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);text-align:center;margin-top:8px}

.compare-modal{position:fixed;inset:0;z-index:4000;display:flex;align-items:center;justify-content:center}
.compare-backdrop{position:absolute;inset:0;background:rgba(0,0,0,0.9)}
.compare-inner{position:relative;z-index:1;background:var(--bg-surface);border:1px solid var(--border-mid);border-radius:8px;width:92vw;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.compare-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border-dim)}
.compare-title{font-family:var(--font-display);font-size:16px;letter-spacing:2px;color:var(--accent)}
.compare-close{background:none;border:1px solid var(--border-mid);border-radius:3px;color:var(--text-dim);font-size:12px;padding:4px 10px;cursor:pointer}
.compare-close:hover{border-color:var(--red);color:var(--red)}
.compare-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;padding:16px;overflow-y:auto;flex:1}
.compare-item{border:1px solid var(--border-dim);border-radius:4px;overflow:hidden}
.compare-item-title{padding:6px 10px;background:rgba(0,0,0,0.3);font-family:var(--font-mono);font-size:10px;color:var(--text-secondary);letter-spacing:1px;border-bottom:1px solid var(--border-dim)}
.compare-item img{width:100%;object-fit:contain;max-height:300px}

.toast{position:fixed;bottom:24px;right:24px;background:var(--bg-surface);border:1px solid var(--border-mid);border-radius:5px;padding:10px 18px;font-family:var(--font-mono);font-size:12px;color:var(--text-primary);z-index:9000;box-shadow:0 8px 32px rgba(0,0,0,0.8);animation:slideIn .2s ease}
@keyframes slideIn{from{transform:translateX(20px);opacity:0}to{transform:none;opacity:1}}
</style>
</head>

<body>
<!-- LOGIN -->
<div id="loginOverlay" class="login-overlay">
  <div class="login-box">
    <div class="login-emblem">
      <div class="emblem-ring"></div>
      <div class="emblem-inner"><span class="emblem-icon">⬡</span></div>
    </div>
    <div class="login-title">VENEZUELA ABSOLUTE RESOLVE</div>
    <div class="login-subtitle">OPERATIONAL WEATHER ANALYSIS SYSTEM</div>
    <div class="login-classification">// ACCESS RESTRICTED //</div>

    <div class="login-fields">
      <div class="field-group">
        <label class="field-label" for="loginUser">OPERATOR ID</label>
        <input type="text" id="loginUser" class="login-input" placeholder="Enter operator ID" autocomplete="off" />
      </div>
      <div class="field-group">
        <label class="field-label" for="loginPass">ACCESS CODE</label>
        <input type="password" id="loginPass" class="login-input" placeholder="Enter access code" autocomplete="off" />
      </div>
      <div class="login-hint">Default: demo / demo1234</div>
      <button class="login-btn" type="button" id="loginBtn">
        <span class="btn-text">AUTHENTICATE</span>
        <span class="btn-arrow">→</span>
      </button>
      <div id="loginError" class="login-error hidden">AUTHENTICATION FAILED - INVALID CREDENTIALS</div>
    </div>

    <div class="login-footer"><span class="status-dot active"></span> SYSTEM OPERATIONAL</div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app hidden">
  <header class="header">
    <div class="header-left">
      <div class="header-logo"><span class="logo-hex">⬡</span></div>
      <div class="header-brand">
        <div class="brand-mission">VENEZUELA ABSOLUTE RESOLVE</div>
        <div class="brand-sub">OPERATIONAL WEATHER ANALYSIS SYSTEM</div>
      </div>
    </div>

    <div class="header-center">
      <div class="search-wrap">
        <span class="search-icon">⌕</span>
        <input type="text" id="globalSearch" class="search-input" placeholder="SEARCH SECTIONS, CONTENT..." />
        <span class="search-clear" id="searchClear">✕</span>
      </div>
    </div>

    <div class="header-right">
      <div class="header-clock">
        <div class="clock-utc" id="clockUTC">00:00:00Z</div>
        <div class="clock-date" id="clockDate">-- --- ----</div>
      </div>
      <div class="header-status"><span class="status-dot active"></span><span class="status-label">LIVE</span></div>
      <button class="logout-btn" type="button" id="logoutBtn" title="Logout">⏻</button>
    </div>
  </header>

  <div class="loc-tabs">
    <div class="loc-tab-track" id="locTabTrack">
      <button class="loc-tab active" data-loc="TJRV" type="button">
        <span class="loc-icao">TJRV</span><span class="loc-name">Roosevelt Roads, PR</span>
      </button>
      <button class="loc-tab" data-loc="SVMI" type="button">
        <span class="loc-icao">SVMI</span><span class="loc-name">Simon Bolivar, VE</span>
      </button>
      <button class="loc-tab-add" id="addAorBtn" type="button" title="Duplicate AOR"><span>+ AOR</span></button>
    </div>
    <div class="loc-cycle">
      <span class="cycle-label">CYCLE:</span>
      <select class="cycle-select" id="cycleSelect">
        <option value="00Z">00Z</option>
        <option value="06Z">06Z</option>
        <option value="12Z" selected>12Z</option>
        <option value="18Z">18Z</option>
      </select>
    </div>
  </div>

  <nav class="section-nav">
    <div class="nav-items" id="sectionNav">
      <button class="nav-item active" data-section="climatology" type="button"><span class="nav-icon">◈</span> CLIMATOLOGY</button>
      <button class="nav-item" data-section="observations" type="button"><span class="nav-icon">◈</span> OBSERVATIONS</button>
      <button class="nav-item" data-section="upper-air" type="button"><span class="nav-icon">◈</span> UPPER AIR</button>
      <button class="nav-item" data-section="model-guidance" type="button"><span class="nav-icon">◈</span> MODEL GUIDANCE</button>
      <button class="nav-item" data-section="integrated" type="button"><span class="nav-icon">◈</span> INTEGRATED ASSESSMENT</button>
      <button class="nav-item" data-section="archive" type="button"><span class="nav-icon">◈</span> ARCHIVE</button>
    </div>
  </nav>

  <main class="content" id="mainContent"></main>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox hidden" aria-hidden="true">
  <div class="lightbox-backdrop" id="lightboxBackdrop"></div>
  <div class="lightbox-inner">
    <button class="lightbox-close" type="button" id="lightboxClose">✕ CLOSE</button>
    <img id="lightboxImg" src="" alt="" />
    <div class="lightbox-caption" id="lightboxCaption"></div>
  </div>
</div>

<!-- COMPARE MODAL -->
<div id="compareModal" class="compare-modal hidden" aria-hidden="true">
  <div class="compare-backdrop" id="compareBackdrop"></div>
  <div class="compare-inner">
    <div class="compare-header">
      <span class="compare-title">SIDE-BY-SIDE COMPARISON</span>
      <button class="compare-close" type="button" id="compareClose">✕</button>
    </div>
    <div class="compare-grid" id="compareGrid"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast hidden"></div>

<script>
/* ============================================================
   OPWS - Single-file app
   - Login gate + sessionStorage
   - Tabs: Locations + Sections
   - Upload cards with localStorage persistence
============================================================ */

const STATE = {
  currentLocation: "TJRV",
  currentSection: "climatology",
  currentCycle: "12Z",
  locations: ["TJRV","SVMI"],
  searchQuery: "",
  compareImages: {},        // key -> {src,label,loc,section,cardId}
  uploadedImages: {},       // key -> dataURL
  analysisNotes: {},        // key -> text
  archiveRows: {},          // loc -> rows
  stoplightData: {},        // loc -> rows
  timelineRisks: {},        // loc__day -> g/a/r
  loginUser: null,
};

const LS_KEY = "var_opws_state_v2";
const SESSION_KEY = "var_opws_user_v2";
const VALID_CREDENTIALS = { demo: "demo1234", admin: "opws2025", analyst: "wx4ops!" };

function safeId(s){ return String(s).replace(/[^a-z0-9_-]/gi, "_"); }

/* ---------- Persistence ---------- */
function saveState(){
  try{
    const toSave = {
      uploadedImages: STATE.uploadedImages,
      analysisNotes: STATE.analysisNotes,
      archiveRows: STATE.archiveRows,
      stoplightData: STATE.stoplightData,
      timelineRisks: STATE.timelineRisks,
      locations: STATE.locations,
    };
    localStorage.setItem(LS_KEY, JSON.stringify(toSave));
  }catch(e){
    console.warn("Save failed", e);
  }
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const saved = JSON.parse(raw);
    Object.assign(STATE, saved);
  }catch(e){
    console.warn("Load failed", e);
  }
}

/* ---------- Helpers ---------- */
function escapeHtml(s){
  if(s === null || s === undefined) return "";
  return String(s)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#39;");
}
function showToast(msg, duration=2500){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.remove("hidden");
  clearTimeout(t._timer);
  t._timer = setTimeout(()=>t.classList.add("hidden"), duration);
}
function startClock(){
  const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  const pad = n => String(n).padStart(2,"0");
  function tick(){
    const now = new Date();
    document.getElementById("clockUTC").textContent =
      `${pad(now.getUTCHours())}:${pad(now.getUTCMinutes())}:${pad(now.getUTCSeconds())}Z`;
    document.getElementById("clockDate").textContent =
      `${pad(now.getUTCDate())} ${months[now.getUTCMonth()]} ${now.getUTCFullYear()}`;
  }
  tick(); setInterval(tick, 1000);
}

/* ---------- Image + Notes ---------- */
function imgKey(loc, section, cardId){ return `${loc}__${section}__${cardId}`; }
function getImage(loc, section, cardId){ return STATE.uploadedImages[imgKey(loc,section,cardId)] || null; }
function setImage(loc, section, cardId, dataURL){ STATE.uploadedImages[imgKey(loc,section,cardId)] = dataURL; saveState(); }
function clearImage(loc, section, cardId){ delete STATE.uploadedImages[imgKey(loc,section,cardId)]; saveState(); }

function noteKey(loc, section, fieldId){ return `${loc}__${section}__${fieldId}`; }
function getNote(loc, section, fieldId){ return STATE.analysisNotes[noteKey(loc,section,fieldId)] || ""; }
function setNote(loc, section, fieldId, text){ STATE.analysisNotes[noteKey(loc,section,fieldId)] = text; saveState(); }

/* ---------- Archive + Stoplight defaults ---------- */
function defaultArchiveRows(){
  return [{ id: 1, date: new Date().toISOString().slice(0,10), cycle: "12Z", section:"climatology", version:"v1.0", analyst:"", notes:"", locked:false }];
}
function getArchive(loc){
  if(!STATE.archiveRows[loc]) STATE.archiveRows[loc] = defaultArchiveRows();
  return STATE.archiveRows[loc];
}
function setArchive(loc, rows){ STATE.archiveRows[loc] = rows; saveState(); }

function defaultStoplight(){
  return [
    { threat:"Low-Level Turbulence", air:"a", isr:"g", maritime:"g", ground:"g", remarks:"" },
    { threat:"Convective Activity / CBs", air:"r", isr:"r", maritime:"a", ground:"a", remarks:"" },
    { threat:"Icing (FL100-FL200)", air:"a", isr:"a", maritime:"g", ground:"g", remarks:"" },
    { threat:"Low Visibility / Fog", air:"r", isr:"r", maritime:"a", ground:"a", remarks:"" },
    { threat:"High Surface Winds", air:"a", isr:"g", maritime:"r", ground:"a", remarks:"" },
    { threat:"High Upper Winds (>=100kts)", air:"a", isr:"a", maritime:"g", ground:"g", remarks:"" },
    { threat:"IR Degradation", air:"g", isr:"r", maritime:"g", ground:"g", remarks:"" },
    { threat:"Radar Degradation", air:"g", isr:"r", maritime:"a", ground:"g", remarks:"" },
  ];
}
function getStoplight(loc){
  if(!STATE.stoplightData[loc]) STATE.stoplightData[loc] = defaultStoplight();
  return STATE.stoplightData[loc];
}
function setStoplight(loc, data){ STATE.stoplightData[loc] = data; saveState(); }

function getTimelineRisk(loc, day){ return STATE.timelineRisks[`${loc}__${day}`] || ""; }
function setTimelineRisk(loc, day, risk){ STATE.timelineRisks[`${loc}__${day}`] = risk; saveState(); }

/* ---------- UI builders ---------- */
function buildPageHeader(title, subtitle, chips=[]){
  return `
    <div class="page-header">
      <div class="page-header-inner">
        <div>
          <div class="page-title">${escapeHtml(title)}</div>
          <div class="page-subtitle">${escapeHtml(subtitle)}</div>
        </div>
      </div>
      ${chips.length ? `<div class="page-meta">${chips.map(c => `<span class="meta-chip ${c.active ? "active" : ""}">${escapeHtml(c.label)}</span>`).join("")}</div>` : ""}
    </div>
  `;
}
function buildCollapsible(id, num, title, badge, content, defaultOpen=true){
  const safe = safeId(id);
  return `
    <div class="collapsible ${defaultOpen ? "" : "collapsed"}" id="coll-${safe}">
      <div class="collapsible-header" data-coll="${safe}">
        <div class="collapsible-left">
          <span class="collapsible-num">${escapeHtml(num||"")}</span>
          <span class="collapsible-title">${escapeHtml(title)}</span>
          ${badge ? `<span class="collapsible-badge">${escapeHtml(badge)}</span>` : ""}
        </div>
        <div class="collapsible-right">
          <span class="chevron ${defaultOpen ? "open" : ""}" id="chev-${safe}">▶</span>
        </div>
      </div>
      <div class="collapsible-body">${content}</div>
    </div>
  `;
}
function buildCard(title, content, actions=""){
  return `
    <div class="card fade-in">
      <div class="card-head">
        <span class="card-title">${escapeHtml(title)}</span>
        <div class="card-actions">${actions}</div>
      </div>
      <div class="card-body">${content}</div>
    </div>
  `;
}

function buildAnalysisField(loc, section, fieldId, placeholder="Enter analyst discussion..."){
  const val = getNote(loc, section, fieldId);
  const id = safeId(`af-${loc}-${section}-${fieldId}`);
  return `
    <span class="analysis-label">ANALYST DISCUSSION</span>
    <textarea class="analysis-field" id="${id}" placeholder="${escapeHtml(placeholder)}"
      data-note-loc="${escapeHtml(loc)}" data-note-sec="${escapeHtml(section)}" data-note-id="${escapeHtml(fieldId)}"
    >${escapeHtml(val)}</textarea>
  `;
}

function buildDiscussionNotes(loc, section, fieldId){
  const k = `disc_${fieldId}`;
  const val = getNote(loc, section, k);
  const id = safeId(`dn-${loc}-${section}-${fieldId}`);
  return `
    <div class="discussion-wrap">
      <div class="discussion-toggle" data-disc="${id}">
        <span id="disc-chev-${id}">▶</span> COLLAPSIBLE DISCUSSION NOTES
      </div>
      <div class="discussion-body hidden" id="disc-body-${id}">
        <textarea class="discussion-field" placeholder="Extended discussion notes, model comparison, uncertainty..."
          data-note-loc="${escapeHtml(loc)}" data-note-sec="${escapeHtml(section)}" data-note-id="${escapeHtml(k)}"
        >${escapeHtml(val)}</textarea>
      </div>
    </div>
  `;
}

function buildUploadZone(loc, section, cardId, opts={}){
  const label = opts.label || "";
  const allowGif = (opts.allowGif !== false);
  const showCompare = !!opts.showCompare;
  const existing = getImage(loc, section, cardId);
  const zoneId = safeId(`uz-${loc}-${section}-${cardId}`);
  const isGif = existing && existing.startsWith("data:image/gif");

  return `
    <div class="upload-zone ${existing ? "has-content" : ""}" id="${zoneId}"
      data-loc="${escapeHtml(loc)}" data-sec="${escapeHtml(section)}" data-card="${escapeHtml(cardId)}"
    >
      ${existing
        ? `<img src="${existing}" class="${isGif ? "upload-gif" : "upload-preview"}" alt="${escapeHtml(label)}" />`
        : `<div class="upload-icon">⬆</div>
           <div class="upload-text"><strong>DRAG & DROP</strong><br/>or click to upload<br/>${allowGif ? "PNG · JPG · GIF" : "PNG · JPG"}</div>`
      }
      <input type="file" accept="${allowGif ? "image/*" : "image/png,image/jpeg"}" />
    </div>
    <div class="upload-controls" data-controls-for="${zoneId}">
      ${existing ? `
        <button class="card-btn" type="button" data-expand="${zoneId}" data-caption="${escapeHtml(label)}">⊞ EXPAND</button>
        <button class="card-btn danger" type="button" data-clear="${zoneId}">✕ CLEAR</button>
        ${showCompare ? `<button class="card-btn" type="button" data-compare="${zoneId}" data-label="${escapeHtml(label)}">⊟ COMPARE</button>` : ""}
      ` : ""}
    </div>
  `;
}

/* ---------- Sections ---------- */
function buildClimatology(loc){
  const S="climatology";
  const items = [
    {id:"monthly", num:"01", title:"MONTHLY AVERAGES", badge:"CLIMO", ph:"Describe monthly temperature, precipitation, and wind averages..."},
    {id:"seasonal",num:"02", title:"SEASONAL WIND PATTERNS", badge:"SYNOPTIC", ph:"Describe dominant seasonal wind regimes, trade winds, monsoon influence..."},
    {id:"precip",  num:"03", title:"PRECIPITATION NORMALS", badge:"HYDRO", ph:"Describe annual precipitation distribution, wet/dry seasons, extremes..."},
    {id:"tropical",num:"04", title:"TROPICAL CYCLONE CLIMATOLOGY", badge:"TROP", ph:"Describe TC tracks, frequency, historical landfalls, peak season..."},
    {id:"hse",     num:"05", title:"HISTORICAL SIGNIFICANT EVENTS", badge:"ARCHIVE", ph:"Describe notable historical weather events, records, extremes..."},
    {id:"enso",    num:"06", title:"ENSO INFLUENCES", badge:"ENSO", ph:"Describe El Nino and La Nina impacts on local climate patterns..."},
  ];
  return buildPageHeader("CLIMATOLOGY", `HISTORICAL CLIMATE ANALYSIS - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: CLIMO"},
    {label:`CYCLE: ${STATE.currentCycle}`},
  ]) + items.map(it => buildCollapsible(
    `${loc}_${it.id}`, it.num, it.title, it.badge,
    `<div class="grid-2">
       ${buildUploadZone(loc,S,it.id,{label:it.title, allowGif:true})}
       <div>${buildAnalysisField(loc,S,`ana_${it.id}`,it.ph)}${buildDiscussionNotes(loc,S,it.id)}</div>
     </div>`
  )).join("");
}

function buildObservations(loc){
  const S="observations";
  const items = [
    {id:"meteogram", num:"01", title:"METEOGRAM", badge:"OBS", gif:false, ph:"Discuss meteogram trends, QPF accumulations, wind evolution..."},
    {id:"surface_obs", num:"02", title:"SURFACE OBSERVATIONS", badge:"METAR", gif:false, ph:"Discuss METAR/SYNOP analysis, surface pressure patterns, fronts..."},
    {id:"skewt", num:"03", title:"OBSERVED SKEW-T", badge:"SOUNDING", gif:false, ph:"Discuss thermodynamic profile, instability indices, moisture..."},
    {id:"sat_vis", num:"04", title:"SATELLITE - VIS", badge:"SAT", gif:true, ph:"Discuss visible satellite features, cloud morphology, optical depth..."},
    {id:"sat_ir", num:"05", title:"SATELLITE - IR", badge:"SAT", gif:true, ph:"Discuss IR temperatures, convective tops, cirrus shields..."},
    {id:"sat_wv", num:"06", title:"SATELLITE - WATER VAPOR", badge:"SAT", gif:true, ph:"Discuss WV channel features, upper-level dynamics, jet stream..."},
    {id:"radar", num:"07", title:"RADAR LOOPS", badge:"RADAR", gif:true, ph:"Discuss radar reflectivity patterns, precipitation type, coverage..."},
    {id:"lightning", num:"08", title:"LIGHTNING", badge:"LGHT", gif:true, ph:"Discuss lightning density, CG flash rate, convective cells..."},
  ];
  return buildPageHeader("OBSERVATIONS", `CURRENT CONDITIONS & LOOP ANALYSIS - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: OBS"},
  ]) + items.map(it => buildCollapsible(
    `${loc}_obs_${it.id}`, it.num, it.title, it.badge,
    `<div class="grid-2">
      ${buildUploadZone(loc,S,it.id,{label:it.title, allowGif:it.gif, showCompare:false})}
      <div>${buildAnalysisField(loc,S,`ana_${it.id}`,it.ph)}${buildDiscussionNotes(loc,S,it.id)}</div>
    </div>`
  )).join("");
}

function buildUpperAir(loc){
  const S="upper-air";
  const levels = ["300mb","500mb","700mb","850mb","Surface"];
  const levelLabels = { "300mb":"300 MB", "500mb":"500 MB", "700mb":"700 MB", "850mb":"850 MB", "Surface":"SURFACE" };
  const levelDesc = {
    "300mb":"jet stream, divergence, wind maxima",
    "500mb":"mid-level trough/ridge, height anomalies",
    "700mb":"mid-level moisture, thermal advection",
    "850mb":"low-level jet, moisture flux, warm advection",
    "Surface":"surface pressure, fronts, convergence zones",
  };
  const containerId = safeId(`ua-${loc}`);

  const tabs = `<div class="level-tabs" id="${containerId}-tabs">` + levels.map((lv,i)=>`
    <button class="level-tab ${i===0?"active":""}" type="button" data-level="${lv}" data-lv-cont="${containerId}">${levelLabels[lv]}</button>
  `).join("") + `</div>`;

  const panes = `<div id="${containerId}-panes">` + levels.map((lv,i)=>`
    <div class="level-pane ${i===0?"":"hidden"}" data-level="${lv}">
      ${buildCollapsible(`${loc}_ua_${lv}`,"",`${levelLabels[lv]} - ANALYSIS CHART`,"ANALYSIS",
        `<div class="grid-2">
          ${buildUploadZone(loc,S,`ua_${lv}`,{label:`${levelLabels[lv]} Analysis`, showCompare:true})}
          <div>${buildAnalysisField(loc,S,`ua_ana_${lv}`,`Discuss ${levelDesc[lv]}...`)}${buildDiscussionNotes(loc,S,`ua_${lv}`)}</div>
        </div>`
      )}
    </div>
  `).join("") + `</div>`;

  return buildPageHeader("UPPER AIR ANALYSIS", `SYNOPTIC-SCALE PATTERN ANALYSIS - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: UPPER AIR"},
  ]) + buildCard("PRESSURE LEVEL SELECTOR", tabs + panes,
    `<button class="card-btn" type="button" id="openCompareBtn">⊟ OPEN COMPARE VIEW</button>`
  );
}

function buildModelGuidance(loc){
  const S="model-guidance";
  const levels = ["300mb","500mb","700mb","850mb","Surface"];
  const products = [
    {id:"deterministic", label:"DETERMINISTIC"},
    {id:"ensemble", label:"ENSEMBLE"},
    {id:"cape", label:"CAPE"},
    {id:"pwat", label:"PWAT"},
    {id:"vvel", label:"VERT. VELOCITY"},
    {id:"wind", label:"WIND FIELDS"},
    {id:"qpf", label:"QPF"},
    {id:"thickness", label:"THICKNESS"},
  ];
  const cont = safeId(`mg-${loc}`);

  const lvlTabs = `<div class="level-tabs" id="${cont}-tabs">` + levels.map((lv,i)=>`
    <button class="level-tab ${i===0?"active":""}" type="button" data-level="${lv}" data-lv-cont="${cont}">${lv}</button>
  `).join("") + `</div>`;

  const lvlPanes = `<div id="${cont}-panes">` + levels.map((lv,i)=>{
    const prodTabs = `<div class="model-product-tabs" id="${cont}-${lv}-ptabs">` + products.map((p,j)=>`
      <button class="model-product-tab ${j===0?"active":""}" type="button" data-prod="${p.id}" data-prod-cont="${cont}-${lv}">${p.label}</button>
    `).join("") + `</div>`;

    const prodPanes = `<div id="${cont}-${lv}-ppanes">` + products.map((p,j)=>`
      <div class="model-pane ${j===0?"":"hidden"}" data-prod="${p.id}">
        <div class="grid-2">
          ${buildUploadZone(loc,S,`mg_${lv}_${p.id}`,{label:`${lv} - ${p.label}`, showCompare:true})}
          <div>${buildAnalysisField(loc,S,`mg_${lv}_${p.id}`,`Discuss ${p.label.toLowerCase()} at ${lv}...`)}${buildDiscussionNotes(loc,S,`mg_${lv}_${p.id}`)}</div>
        </div>
      </div>
    `).join("") + `</div>`;

    return `
      <div class="level-pane ${i===0?"":"hidden"}" data-level="${lv}">
        ${prodTabs}
        <div data-prod-wrapper="${cont}-${lv}">${prodPanes}</div>
      </div>
    `;
  }).join("") + `</div>`;

  return buildPageHeader("MODEL GUIDANCE", `NWP ANALYSIS - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: MODEL"},
    {label:`CYCLE: ${STATE.currentCycle}`},
  ]) + buildCard("PRESSURE LEVEL / PRODUCT SELECTOR", lvlTabs + lvlPanes,
    `<button class="card-btn" type="button" id="openCompareBtn">⊟ COMPARE VIEW</button>`
  );
}

function lightCell(val, loc, rowIdx, col){
  const map = { g:"GREEN", a:"AMBER", r:"RED" };
  return `
    <td>
      <select data-stop-loc="${escapeHtml(loc)}" data-stop-row="${rowIdx}" data-stop-col="${escapeHtml(col)}" class="${escapeHtml(val)}">
        ${["g","a","r"].map(v => `<option value="${v}" ${val===v?"selected":""}>${map[v]}</option>`).join("")}
      </select>
    </td>
  `;
}

function buildIntegrated(loc){
  const S="integrated";
  const threatContent = `
    ${buildUploadZone(loc,S,"threat_chart",{label:"Threat Summary Chart"})}
    ${buildAnalysisField(loc,S,"threat_main","Describe primary weather threats, confidence levels, and key uncertainties...")}
  `;

  const assets = ["Air","ISR","Maritime","Ground"];
  const assetContent = `
    <div style="overflow-x:auto">
      <table class="asset-table">
        <thead><tr><th>ASSET</th><th>WEATHER PARAMETER</th><th>IMPACT</th><th>MITIGATION</th></tr></thead>
        <tbody>
          ${assets.map(a => `
            <tr>
              <td style="padding:8px 12px;font-family:var(--font-mono);font-size:11px;font-weight:700;color:var(--accent);white-space:nowrap">${a.toUpperCase()}</td>
              ${["param","impact","mitig"].map(kind => `
                <td>
                  <textarea data-note-loc="${escapeHtml(loc)}" data-note-sec="${escapeHtml(S)}" data-note-id="asset_${kind}_${a}"
                    placeholder="${kind==="param"?"Weather parameters...":kind==="impact"?"Operational impacts...":"Recommended mitigation..."}"
                  >${escapeHtml(getNote(loc,S,`asset_${kind}_${a}`))}</textarea>
                </td>
              `).join("")}
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
  `;

  const irContent = `<div class="grid-2">
    ${buildUploadZone(loc,S,"ir_deg",{label:"IR Degradation Chart"})}
    <div>${buildAnalysisField(loc,S,"ir_deg_notes","Describe cloud cover, optical depth, and IR sensor degradation impacts on ISR and targeting...")}</div>
  </div>`;

  const radarContent = `<div class="grid-2">
    ${buildUploadZone(loc,S,"radar_deg",{label:"Radar Degradation Chart"})}
    <div>${buildAnalysisField(loc,S,"radar_deg_notes","Describe precipitation attenuation, ground clutter, anomalous propagation impacts on radar coverage...")}</div>
  </div>`;

  const stopData = getStoplight(loc);
  const stoplightContent = `
    <div style="overflow-x:auto">
      <table class="stoplight-table">
        <thead><tr>
          <th style="min-width:200px">WEATHER THREAT</th><th>AIR</th><th>ISR</th><th>MARITIME</th><th>GROUND</th><th style="min-width:200px">REMARKS</th>
        </tr></thead>
        <tbody>
          ${stopData.map((row,i)=>`
            <tr>
              <td><input value="${escapeHtml(row.threat)}" data-stop-edit="threat" data-stop-loc="${escapeHtml(loc)}" data-stop-row="${i}" /></td>
              ${["air","isr","maritime","ground"].map(col=>lightCell(row[col],loc,i,col)).join("")}
              <td><input value="${escapeHtml(row.remarks)}" placeholder="Add remarks..." data-stop-edit="remarks" data-stop-loc="${escapeHtml(loc)}" data-stop-row="${i}" /></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    </div>
    <div style="margin-top:10px;display:flex;gap:12px">
      <span style="font-family:var(--font-mono);font-size:10px" class="g">■ GREEN = Minimal Impact</span>
      <span style="font-family:var(--font-mono);font-size:10px" class="a">■ AMBER = Moderate Impact</span>
      <span style="font-family:var(--font-mono);font-size:10px" class="r">■ RED = Significant Impact</span>
    </div>
  `;

  const days = [{k:"D5",l:"D-5"},{k:"D4",l:"D-4"},{k:"D3",l:"D-3"},{k:"D2",l:"D-2"},{k:"D1",l:"D-1"},{k:"D0",l:"D-0"}];
  const timelineContent = `
    <div class="timeline">
      ${days.map(d=>{
        const risk = getTimelineRisk(loc,d.k);
        const noteVal = getNote(loc,S,`timeline_${d.k}`);
        return `
          <div class="timeline-day">
            <div class="timeline-day-head"><div class="timeline-day-label">${d.l}</div></div>
            <div class="timeline-day-body">
              <textarea class="timeline-field" placeholder="Wx summary..." data-note-loc="${escapeHtml(loc)}" data-note-sec="${escapeHtml(S)}" data-note-id="timeline_${d.k}">${escapeHtml(noteVal)}</textarea>
            </div>
            <div class="timeline-risk">
              <button class="timeline-risk-btn grn ${risk==="g"?"on":""}" type="button" data-risk-loc="${escapeHtml(loc)}" data-risk-day="${d.k}" data-risk="g"></button>
              <button class="timeline-risk-btn amb ${risk==="a"?"on":""}" type="button" data-risk-loc="${escapeHtml(loc)}" data-risk-day="${d.k}" data-risk="a"></button>
              <button class="timeline-risk-btn red ${risk==="r"?"on":""}" type="button" data-risk-loc="${escapeHtml(loc)}" data-risk-day="${d.k}" data-risk="r"></button>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;

  return buildPageHeader("INTEGRATED ASSESSMENT", `SYNTHESIZED OPERATIONAL WEATHER ASSESSMENT - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: INTEGRATED"},
  ]) + [
    buildCollapsible(`${loc}_int_threat`,"01","THREAT ASSESSMENT","PRIMARY",threatContent),
    buildCollapsible(`${loc}_int_assets`,"02","WEATHER IMPACTS TO ASSETS","ALL DOMAINS",assetContent),
    buildCollapsible(`${loc}_int_ir`,"03","IR DEGRADATION IMPACTS","ISR/EO",irContent),
    buildCollapsible(`${loc}_int_radar`,"04","RADAR DEGRADATION IMPACTS","RADAR",radarContent),
    buildCollapsible(`${loc}_int_stop`,"05","STOPLIGHT RISK MATRIX","RISK",stoplightContent),
    buildCollapsible(`${loc}_int_time`,"06","D-5 THROUGH D-0 FORECAST TIMELINE","TIMELINE",timelineContent),
  ].join("");
}

function buildArchive(loc){
  const cycles=["00Z","06Z","12Z","18Z"];
  const sections=["climatology","observations","upper-air","model-guidance","integrated"];
  const rows = getArchive(loc);

  const tableRows = rows.map((row,i)=>`
    <tr>
      <td><input type="date" value="${escapeHtml(row.date)}" data-arch-loc="${escapeHtml(loc)}" data-arch-row="${i}" data-arch-field="date" style="width:130px"/></td>
      <td>
        <select data-arch-loc="${escapeHtml(loc)}" data-arch-row="${i}" data-arch-field="cycle" style="color:var(--accent);cursor:pointer">
          ${cycles.map(c=>`<option value="${c}" ${row.cycle===c?"selected":""}>${c}</option>`).join("")}
        </select>
      </td>
      <td>
        <select data-arch-loc="${escapeHtml(loc)}" data-arch-row="${i}" data-arch-field="section" style="color:var(--text-secondary);cursor:pointer">
          ${sections.map(s=>`<option value="${s}" ${row.section===s?"selected":""}>${s.toUpperCase()}</option>`).join("")}
        </select>
      </td>
      <td><span style="font-family:var(--font-mono);font-size:10px;color:var(--accent);border:1px solid var(--accent-dim);padding:2px 6px;border-radius:2px;background:var(--accent-glow)">${escapeHtml(row.version||"v1.0")}</span></td>
      <td><input value="${escapeHtml(row.analyst||"")}" placeholder="Analyst ID" data-arch-loc="${escapeHtml(loc)}" data-arch-row="${i}" data-arch-field="analyst" style="width:110px"/></td>
      <td><input value="${escapeHtml(row.notes||"")}" placeholder="Brief notes..." data-arch-loc="${escapeHtml(loc)}" data-arch-row="${i}" data-arch-field="notes"/></td>
      <td><button class="card-btn danger" type="button" data-arch-del="${i}">✕</button></td>
    </tr>
  `).join("");

  return buildPageHeader("ARCHIVE", `FORECAST CYCLE ARCHIVE - ${loc}`, [
    {label:`ICAO: ${loc}`, active:true},
    {label:"SECTION: ARCHIVE"},
  ]) + `
    <div class="archive-filters">
      <span style="font-family:var(--font-mono);font-size:10px;color:var(--text-dim)">FILTER BY CYCLE:</span>
      <select data-arch-filter="cycle" style="padding:5px 8px">
        <option value="all">ALL CYCLES</option>${cycles.map(c=>`<option value="${c}">${c}</option>`).join("")}
      </select>
      <select data-arch-filter="section" style="padding:5px 8px">
        <option value="all">ALL SECTIONS</option>${sections.map(s=>`<option value="${s}">${s.toUpperCase()}</option>`).join("")}
      </select>
    </div>

    <div class="card fade-in">
      <div class="card-head"><span class="card-title">FORECAST CYCLE LOG - ${escapeHtml(loc)}</span></div>
      <div class="card-body" style="overflow-x:auto">
        <table class="archive-table" id="archive-table-${escapeHtml(loc)}">
          <thead><tr><th>DATE</th><th>CYCLE</th><th>SECTION</th><th>VERSION</th><th>ANALYST</th><th>NOTES</th><th></th></tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
        <button class="add-row-btn" type="button" id="addArchiveBtn">+ ADD ENTRY</button>
      </div>
    </div>
  `;
}

/* ---------- Rendering ---------- */
function renderLocationTabs(){
  const track = document.getElementById("locTabTrack");
  const addBtn = document.getElementById("addAorBtn");
  track.querySelectorAll(".loc-tab").forEach(el => el.remove());
  const names = { TJRV:"Roosevelt Roads, PR", SVMI:"Simon Bolivar, VE" };

  STATE.locations.forEach(loc=>{
    const btn = document.createElement("button");
    btn.type="button";
    btn.className = `loc-tab ${loc===STATE.currentLocation ? "active":""}`;
    btn.dataset.loc = loc;
    btn.innerHTML = `<span class="loc-icao">${escapeHtml(loc)}</span><span class="loc-name">${escapeHtml(names[loc]||"AOR Location")}</span>`;
    btn.addEventListener("click", ()=>switchLocation(loc));
    track.insertBefore(btn, addBtn);
  });
}

function renderSectionNav(){
  document.querySelectorAll("#sectionNav .nav-item").forEach(el=>{
    el.classList.toggle("active", el.dataset.section === STATE.currentSection);
  });
}

function renderSection(){
  const content = document.getElementById("mainContent");
  const loc = STATE.currentLocation;
  const sec = STATE.currentSection;

  let html = "";
  if(sec==="climatology") html = buildClimatology(loc);
  else if(sec==="observations") html = buildObservations(loc);
  else if(sec==="upper-air") html = buildUpperAir(loc);
  else if(sec==="model-guidance") html = buildModelGuidance(loc);
  else if(sec==="integrated") html = buildIntegrated(loc);
  else if(sec==="archive") html = buildArchive(loc);
  else html = buildClimatology(loc);

  content.innerHTML = html;
  content.scrollTop = 0;

  // Reapply search filter if needed
  if(STATE.searchQuery) applySearch();
}

/* ---------- Behavior / Events ---------- */
function toggleCollapsibleBySafeId(safe){
  const el = document.getElementById(`coll-${safe}`);
  if(!el) return;
  el.classList.toggle("collapsed");
  const chev = document.getElementById(`chev-${safe}`);
  if(chev) chev.classList.toggle("open");
}

function toggleDiscussion(id){
  const body = document.getElementById(`disc-body-${id}`);
  const chev = document.getElementById(`disc-chev-${id}`);
  if(!body) return;
  body.classList.toggle("hidden");
  if(chev) chev.textContent = body.classList.contains("hidden") ? "▶" : "▼";
}

/* Upload handling */
function processFile(file, loc, section, cardId, zoneId){
  if(!file || !file.type || !file.type.startsWith("image/")){
    showToast("File must be an image"); return;
  }
  const reader = new FileReader();
  reader.onload = ev => {
    const dataURL = ev.target.result;
    setImage(loc, section, cardId, dataURL);

    const zone = document.getElementById(zoneId);
    if(zone){
      const isGif = file.type === "image/gif";
      zone.classList.add("has-content");
      zone.innerHTML = `<img src="${dataURL}" class="${isGif?"upload-gif":"upload-preview"}" alt="${escapeHtml(cardId)}" />
                        <input type="file" accept="image/*" />`;
    }
    // controls
    const controls = document.querySelector(`[data-controls-for="${zoneId}"]`);
    if(controls){
      const label = cardId;
      controls.innerHTML = `
        <button class="card-btn" type="button" data-expand="${zoneId}" data-caption="${escapeHtml(label)}">⊞ EXPAND</button>
        <button class="card-btn danger" type="button" data-clear="${zoneId}">✕ CLEAR</button>
        <button class="card-btn" type="button" data-compare="${zoneId}" data-label="${escapeHtml(label)}">⊟ COMPARE</button>
      `;
    }
    showToast("Image uploaded");
  };
  reader.readAsDataURL(file);
}

function removeUpload(loc, section, cardId, zoneId){
  clearImage(loc, section, cardId);
  const zone = document.getElementById(zoneId);
  if(zone){
    zone.classList.remove("has-content");
    zone.innerHTML = `<div class="upload-icon">⬆</div>
      <div class="upload-text"><strong>DRAG & DROP</strong><br/>or click to upload<br/>PNG · JPG · GIF</div>
      <input type="file" accept="image/*" />`;
  }
  const controls = document.querySelector(`[data-controls-for="${zoneId}"]`);
  if(controls) controls.innerHTML = "";
  showToast("Image cleared");
}

/* Lightbox */
function openLightbox(zoneId, caption){
  const zone = document.getElementById(zoneId);
  const img = zone ? zone.querySelector("img") : null;
  if(!img) return;
  document.getElementById("lightboxImg").src = img.src;
  document.getElementById("lightboxCaption").textContent = caption || "";
  document.getElementById("lightbox").classList.remove("hidden");
}
function closeLightbox(){ document.getElementById("lightbox").classList.add("hidden"); }

/* Compare */
function toggleCompare(loc, section, cardId, label){
  const key = imgKey(loc,section,cardId);
  const src = getImage(loc,section,cardId);
  if(!src){ showToast("No image to compare"); return; }
  if(STATE.compareImages[key]){ delete STATE.compareImages[key]; showToast("Removed from comparison"); }
  else { STATE.compareImages[key] = {src,label,loc,section,cardId}; showToast("Added to comparison"); }
}
function openCompare(){
  const items = Object.values(STATE.compareImages);
  if(items.length < 2){ showToast("Add at least 2 images for comparison"); return; }
  document.getElementById("compareGrid").innerHTML = items.map(it=>`
    <div class="compare-item">
      <div class="compare-item-title">${escapeHtml(it.label)} - ${escapeHtml(it.loc)}</div>
      <img src="${it.src}" alt="${escapeHtml(it.label)}" />
    </div>
  `).join("");
  document.getElementById("compareModal").classList.remove("hidden");
}
function closeCompare(){ document.getElementById("compareModal").classList.add("hidden"); }

/* Search */
function applySearch(){
  const q = STATE.searchQuery;
  if(!q){
    document.querySelectorAll(".collapsible,.card").forEach(el=>el.style.display="");
    return;
  }
  document.querySelectorAll(".collapsible").forEach(el=>{
    const text = (el.textContent || "").toLowerCase();
    el.style.display = text.includes(q) ? "" : "none";
    if(text.includes(q)) el.classList.remove("collapsed");
  });
  document.querySelectorAll(".card").forEach(el=>{
    const text = (el.textContent || "").toLowerCase();
    el.style.display = text.includes(q) ? "" : "none";
  });
}
function setSearch(q){
  STATE.searchQuery = (q||"").trim().toLowerCase();
  const clearBtn = document.getElementById("searchClear");
  if(STATE.searchQuery) clearBtn.classList.add("visible"); else clearBtn.classList.remove("visible");
  applySearch();
}

/* Location/Section/Cycle */
function switchLocation(loc){
  STATE.currentLocation = loc;
  document.querySelectorAll(".loc-tab").forEach(el=>el.classList.toggle("active", el.dataset.loc===loc));
  renderSection();
  showToast(`Switched to ${loc}`);
}
function switchSection(section){
  STATE.currentSection = section;
  renderSectionNav();
  renderSection();
}
function setCycle(cycle){
  STATE.currentCycle = cycle;
  showToast(`Forecast cycle set to ${cycle}`);
  renderSection(); // refresh meta chips
}

/* Archive ops */
function addArchiveRow(loc){
  const rows = getArchive(loc);
  const next = rows.length ? rows.length + 1 : 1;
  rows.unshift({
    id: Date.now(),
    date: new Date().toISOString().slice(0,10),
    cycle: STATE.currentCycle,
    section: STATE.currentSection,
    version: `v${next}.0`,
    analyst:"",
    notes:"",
    locked:false,
  });
  setArchive(loc, rows);
  renderSection();
}
function deleteArchiveRow(loc, idx){
  const rows = getArchive(loc);
  rows.splice(idx,1);
  setArchive(loc, rows);
  renderSection();
}
function filterArchive(loc, field, val){
  const rows = document.querySelectorAll(`#archive-table-${loc} tbody tr`);
  rows.forEach(tr=>{
    if(val==="all"){ tr.style.display=""; return; }
    const cell = field==="cycle" ? tr.cells[1] : tr.cells[2];
    const txt = (cell ? cell.textContent : "").trim().toLowerCase();
    tr.style.display = txt.includes(val.toLowerCase()) ? "" : "none";
  });
}

/* Stoplight updates */
function updateStoplightCell(loc, rowIdx, col, val){
  const data = getStoplight(loc);
  data[rowIdx][col] = val;
  setStoplight(loc, data);
}
function updateStoplightThreatOrRemarks(loc, rowIdx, field, val){
  const data = getStoplight(loc);
  data[rowIdx][field] = val;
  setStoplight(loc, data);
}

/* Timeline risk */
function setDayRisk(loc, day, risk){
  setTimelineRisk(loc, day, risk);
  // UI update handled by re-render; this keeps it responsive even without rerender
  document.querySelectorAll(`[data-risk-loc="${loc}"][data-risk-day="${day}"]`).forEach(btn=>{
    btn.classList.toggle("on", btn.dataset.risk === risk);
  });
}

/* ---------- Auth ---------- */
function checkAuth(){
  const session = sessionStorage.getItem(SESSION_KEY);
  if(session){
    STATE.loginUser = session;
    showApp();
  }
}
function attemptLogin(){
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value;
  const errEl = document.getElementById("loginError");

  if(VALID_CREDENTIALS[user] && VALID_CREDENTIALS[user] === pass){
    STATE.loginUser = user;
    sessionStorage.setItem(SESSION_KEY, user);
    errEl.classList.add("hidden");
    document.getElementById("loginOverlay").classList.add("hidden");
    showApp();
  }else{
    errEl.classList.remove("hidden");
    document.getElementById("loginPass").value = "";
    document.getElementById("loginPass").focus();
  }
}
function showApp(){
  document.getElementById("loginOverlay").classList.add("hidden");
  document.getElementById("app").classList.remove("hidden");
  renderApp();
}
function logout(){
  sessionStorage.removeItem(SESSION_KEY);
  STATE.loginUser = null;
  document.getElementById("app").classList.add("hidden");
  document.getElementById("loginOverlay").classList.remove("hidden");
  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";
}

/* ---------- Event delegation ---------- */
function wireGlobalEvents(){
  // Login
  document.getElementById("loginBtn").addEventListener("click", attemptLogin);
  document.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !document.getElementById("loginOverlay").classList.contains("hidden")){
      attemptLogin();
    }
    if(e.key==="Escape"){
      if(!document.getElementById("lightbox").classList.contains("hidden")) closeLightbox();
      if(!document.getElementById("compareModal").classList.contains("hidden")) closeCompare();
    }
  });

  // Top bar
  document.getElementById("logoutBtn").addEventListener("click", logout);
  document.getElementById("cycleSelect").addEventListener("change", (e)=>setCycle(e.target.value));

  // Search
  const search = document.getElementById("globalSearch");
  const clear = document.getElementById("searchClear");
  search.addEventListener("input", ()=>setSearch(search.value));
  clear.addEventListener("click", ()=>{
    search.value=""; setSearch("");
  });

  // Lightbox & compare
  document.getElementById("lightboxBackdrop").addEventListener("click", closeLightbox);
  document.getElementById("lightboxClose").addEventListener("click", closeLightbox);
  document.getElementById("compareBackdrop").addEventListener("click", closeCompare);
  document.getElementById("compareClose").addEventListener("click", closeCompare);

  // Delegated clicks inside main content
  document.getElementById("mainContent").addEventListener("click", (e)=>{
    const coll = e.target.closest(".collapsible-header");
    if(coll){
      toggleCollapsibleBySafeId(coll.dataset.coll);
      return;
    }
    const disc = e.target.closest(".discussion-toggle");
    if(disc){
      toggleDiscussion(disc.dataset.disc);
      return;
    }
    const btnExp = e.target.closest("[data-expand]");
    if(btnExp){
      openLightbox(btnExp.dataset.expand, btnExp.dataset.caption || "");
      return;
    }
    const btnClear = e.target.closest("[data-clear]");
    if(btnClear){
      const zoneId = btnClear.dataset.clear;
      const zone = document.getElementById(zoneId);
      if(!zone) return;
      removeUpload(zone.dataset.loc, zone.dataset.sec, zone.dataset.card, zoneId);
      return;
    }
    const btnComp = e.target.closest("[data-compare]");
    if(btnComp){
      const zoneId = btnComp.dataset.compare;
      const zone = document.getElementById(zoneId);
      if(!zone) return;
      toggleCompare(zone.dataset.loc, zone.dataset.sec, zone.dataset.card, btnComp.dataset.label || zone.dataset.card);
      return;
    }
    const openCompareBtn = e.target.closest("#openCompareBtn");
    if(openCompareBtn){
      openCompare();
      return;
    }
    const riskBtn = e.target.closest("[data-risk]");
    if(riskBtn){
      setDayRisk(riskBtn.dataset.riskLoc, riskBtn.dataset.riskDay, riskBtn.dataset.risk);
      return;
    }
    const delArch = e.target.closest("[data-arch-del]");
    if(delArch && STATE.currentSection==="archive"){
      deleteArchiveRow(STATE.currentLocation, Number(delArch.dataset.archDel));
      return;
    }
  });

  // Delegated changes inside main content (notes, uploads, stoplight, archive)
  document.getElementById("mainContent").addEventListener("input", (e)=>{
    // Notes
    const noteEl = e.target.closest("[data-note-id]");
    if(noteEl){
      setNote(noteEl.dataset.noteLoc, noteEl.dataset.noteSec, noteEl.dataset.noteId, noteEl.value);
      return;
    }
  });

  document.getElementById("mainContent").addEventListener("change", (e)=>{
    // file uploads
    if(e.target && e.target.type==="file"){
      const zone = e.target.closest(".upload-zone");
      if(!zone) return;
      const file = e.target.files && e.target.files[0];
      processFile(file, zone.dataset.loc, zone.dataset.sec, zone.dataset.card, zone.id);
      return;
    }
    // Stoplight selects
    const stopSel = e.target.closest("select[data-stop-col]");
    if(stopSel){
      updateStoplightCell(stopSel.dataset.stopLoc, Number(stopSel.dataset.stopRow), stopSel.dataset.stopCol, stopSel.value);
      stopSel.className = stopSel.value; // visual class
      return;
    }
    // Stoplight threat/remarks inputs
    const stopEdit = e.target.closest("[data-stop-edit]");
    if(stopEdit){
      const field = stopEdit.dataset.stopEdit === "threat" ? "threat" : "remarks";
      updateStoplightThreatOrRemarks(stopEdit.dataset.stopLoc, Number(stopEdit.dataset.stopRow), field, stopEdit.value);
      return;
    }
    // Archive fields
    const arch = e.target.closest("[data-arch-field]");
    if(arch && STATE.currentSection==="archive"){
      const loc = arch.dataset.archLoc;
      const idx = Number(arch.dataset.archRow);
      const field = arch.dataset.archField;
      const rows = getArchive(loc);
      rows[idx][field] = arch.value;
      setArchive(loc, rows);
      return;
    }
    // Archive filters
    const archFilter = e.target.closest("[data-arch-filter]");
    if(archFilter && STATE.currentSection==="archive"){
      filterArchive(STATE.currentLocation, archFilter.dataset.archFilter, archFilter.value);
      return;
    }
  });

  // Drag and drop for uploads (delegated)
  document.getElementById("mainContent").addEventListener("dragover", (e)=>{
    const zone = e.target.closest(".upload-zone");
    if(zone){ e.preventDefault(); zone.classList.add("drag-over"); }
  });
  document.getElementById("mainContent").addEventListener("dragleave", (e)=>{
    const zone = e.target.closest(".upload-zone");
    if(zone) zone.classList.remove("drag-over");
  });
  document.getElementById("mainContent").addEventListener("drop", (e)=>{
    const zone = e.target.closest(".upload-zone");
    if(!zone) return;
    e.preventDefault();
    zone.classList.remove("drag-over");
    const file = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    processFile(file, zone.dataset.loc, zone.dataset.sec, zone.dataset.card, zone.id);
  });

  // Section nav
  document.getElementById("sectionNav").addEventListener("click", (e)=>{
    const btn = e.target.closest(".nav-item");
    if(!btn) return;
    switchSection(btn.dataset.section);
  });

  // AOR add
  document.getElementById("addAorBtn").addEventListener("click", ()=>{
    const name = prompt("Enter ICAO code for new AOR location (e.g. MPTO):");
    if(!name) return;
    const code = name.trim().toUpperCase().slice(0,4);
    if(!code) return;
    if(STATE.locations.includes(code)){ showToast(`${code} already exists`); return; }
    STATE.locations.push(code);
    saveState();
    renderLocationTabs();
    switchLocation(code);
    showToast(`AOR ${code} added`);
  });

  // Location tabs click (already wired per button)
}

/* ---------- App init ---------- */
function renderApp(){
  renderLocationTabs();
  renderSectionNav();
  renderSection();
}

window.addEventListener("DOMContentLoaded", ()=>{
  loadState();
  wireGlobalEvents();
  startClock();
  checkAuth();
});
</script>
</body>
</html>
